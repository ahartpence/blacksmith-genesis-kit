---
meta:
  environment: (( grab genesis.env || params.env ))

  cf:
    exodus_path: (( concat "secret/exodus/" meta.environment "/cf" ))
    deployment_name: (( concat meta.environment "-cf" ))
    system_domain: (( vault meta.cf.exodus_path ":system_domain" ))
    api_url:    (( concat "https://api." meta.cf.system_domain ))
    username:   (( vault meta.cf.exodus_path ":admin_username" ))
    password:   (( vault meta.cf.exodus_path ":admin_password" ))

  default:
    rabbitmq_tags:
      - blacksmith
      - dedicated
      - rabbitmq

    rabbitmq_plans:
      standalone:
        name: standalone
        description: A dedicated RabbitMQ server, with no redundancy or replication
        limit: 7
        type: standalone
        vm_type: default

variables:
- name: blacksmith_rabbitmq_services_ca
  type: certificate
  options:
    is_ca: true
    common_name: (( concat meta.environment "-blacksmith-rabbitmq-services.bosh" ))

releases:
- name:    rabbitmq-forge
  version: 0.5.16l
  url:     https://github.com/itsouvalas/rabbitmq-forge-boshrelease/releases/download/v0.5.16l/rabbitmq-forge-0.5.16l.tgz
  sha1:    88a7aab13937155b5001f044be4824f3b7b6d3cf

params:
  releases:
    - (( append ))
    - (( grab releases.rabbitmq-forge ))
  cf_skip_ssl_validation: false

instance_groups:
  - name: blacksmith
    jobs:
      - release: rabbitmq-forge
        name:    rabbitmq-blacksmith-plans
        properties:
          environment: (( grab meta.environment ))
          cf:
            exodus_path: (( grab meta.cf.exodus_path ))
            deployment_name: (( grab meta.cf.deployment_name ))
            system_domain: (( grab meta.cf.system_domain ))
            api_url:    (( grab meta.cf.api_url ))
            username:   (( grab meta.cf.username ))
            password:   (( grab meta.cf.password ))
          loggregator:
            tls:
              ca_cert: (( vault meta.cf.exodus_path ":loggregator_ca" ))
              agent:
                cert: (( vault meta.cf.exodus_path ":loggregator_tls_agent_cert" ))
                key: (( vault meta.cf.exodus_path ":loggregator_tls_agent_key" ))
          rabbitmq_metrics_emitter:
            cloud_foundry:
              api:    (( grab meta.cf.api_url ))
              skip_ssl_validation: (( grab params.cf_skip_ssl_validation ))
              username:   (( vault meta.cf.exodus_path ":admin_username" ))
              password:   (( vault meta.cf.exodus_path ":admin_password" ))
            rmq_management:
              skip_ssl_validation: (( grab params.emitter_skip_ssl_validation || true ))
              mgmt_port: (( grab params.emitter_mgmt_port || "15671" ))
              mgmt_scheme: (( grab params.emitter_scheme || "https" ))
              mgmt_host: (( grab params.emitter_mgmt_host || "localhost" ))
          blacksmith_rabbitmq_services:
            tls:
              ca_cert: ((blacksmith_rabbitmq_services_ca.certificate))

          plans: (( grab params.rabbitmq_plans || meta.default.rabbitmq_plans ))
          service:
            id:          (( grab params.rabbitmq_service_id          || "rabbitmq" ))
            name:        (( grab params.rabbitmq_service_name        || params.rabbitmq_service_id || "rabbitmq" ))
            description: (( grab params.rabbitmq_service_description || "A dedicated RabbitMQ instance, deployed on-demand" ))
            tags:        (( grab params.rabbitmq_service_tags        || meta.default.rabbitmq_tags ))
            limit:       (( grab params.rabbitmq_service_limit       || 0 ))

